# Code generated by kickr; DO NOT EDIT.

---
kickr:
  image: docker.io/library/alpine:latest
  stage: test
  needs: []
  rules:
    - if: $KICKR_DISABLED == 'true'
      when: never
    - if: $CI_PIPELINE_SOURCE == 'schedule'
  variables:
    COMMIT_MESSAGE: "ci(layout): regenerate kickr layout"
    GIT_DEPTH: "0"
    GIT_STRATEGY: clone
    GITLAB_TOKEN: $KICKR_TOKEN
    MERGE_BODY: Automated kickr layout generation
    MERGE_LABELS: dependencies,kickr
    MERGE_SOURCE_BRANCH: kickr/layout
    MERGE_TARGET_BRANCH: $CI_DEFAULT_BRANCH
    MERGE_TITLE: "ci(layout): regenerate kickr layout"
    # renovate: datasource=github-tags packageName=jdx/mise depName=mise
    MISE_VERSION: v2026.1.6
  before_script:
    - export GOBIN="$HOME/.cache/go/bin"
    - export PATH="$HOME/.local/share/mise/shims:$GOBIN:$PATH"
    - apk update -q && apk add -q curl git jq
    - curl https://mise.run | MISE_INSTALL_PATH=/usr/local/bin/mise MISE_VERSION=$MISE_VERSION sh
    # renovate: datasource=golang-version packageName=golang/go depName=golang
    - mise use -g golang@1.25.5
    # renovate: datasource=gitlab-tags packageName=gitlab-org/cli depName=glab
    - mise use -g glab@1.80.4
    - go install github.com/kickr-dev/kickr/cmd/kickr@beta
  script:
    - kickr generate
    - |-
      set -o pipefail

      glab auth login --token $GITLAB_TOKEN

      # setup git user
      user=$(glab api /user) || {
        echo "$user" >&2 && echo "Failed to retrieve committer informations" >&2 && exit 2
      }
      git config user.name "$(echo "$user" | jq -r '.name')"
      git config user.email "$(echo "$user" | jq -r '.commit_email')"

      # commit changes
      git checkout -b $MERGE_SOURCE_BRANCH
      git commit -am "$COMMIT_MESSAGE" --signoff || {
        echo "No changes detected with $MERGE_TARGET_BRANCH" && exit 0
      }
      git push https://oauth2:$GITLAB_TOKEN@$CI_SERVER_FQDN/$CI_PROJECT_PATH.git $MERGE_SOURCE_BRANCH --force

      # check opened merge requests
      merges=$(glab mr list --source-branch "$MERGE_SOURCE_BRANCH" --target-branch "$MERGE_TARGET_BRANCH" -F json) || {
        echo "$merges" >&2 && echo "Failed to check merge request existence" >&2 && exit 2
      }
      if [ "$(echo "$merges" | jq 'length')" -gt 0 ]; then
        echo "$merges" && echo "Merge request already exist, skipping creation" && exit 0
      fi

      glab mr create --title "$MERGE_TITLE" --description "$MERGE_BODY" \
        --source-branch "$MERGE_SOURCE_BRANCH" --target-branch "$MERGE_TARGET_BRANCH" --remove-source-branch \
        --reviewer "u.kilianpaquier" \
        --label "$MERGE_LABELS"
