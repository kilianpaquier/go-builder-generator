# Code generated by kickr; DO NOT EDIT.

---
include:
  # semantic-release template
  # https://gitlab.com/to-be-continuous/semantic-release
  - project: to-be-continuous/semantic-release
    ref: b339fb11b538e51f6c67eb3eb1c755f5fa85b864 # 4.0.4
    file: templates/gitlab-ci-semrel.yml

variables:
  ADAPTIVE_PIPELINE_DISABLED: "true"
  VERSION: $SEMREL_INFO_NEXT_VERSION

  SEMREL_AUTO_RELEASE_ENABLED: "false"
  SEMREL_BRANCHES_REF: /^(alpha|beta|dev|develop|main|next|rc|staging|v[0-9]+(\.[0-9]+)?\.x)$/
  SEMREL_HOOKS_DIR: scripts
  SEMREL_INFO_ON: all
  SEMREL_RELEASE_DISABLED: "false"
  SEMREL_REQUIRED_PLUGINS_FILE: .gitlab/semrel-plugins.txt
  SEMREL_TAG_FORMAT: v$${version}

# see https://gitlab.com/to-be-continuous/semantic-release/-/blob/master/templates/gitlab-ci-semrel.yml?ref_type=heads#L150
workflow:
  rules:
    - !reference [.tbc-workflow-rules, default]
    # completely disable branches pipelines
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_REF_PROTECTED != "true" && $CI_COMMIT_REF_NAME !~ $PROD_REF && $CI_COMMIT_REF_NAME !~ $INTEG_REF'
      when: never
    - when: always

# override TBC adaptive pipeline in favor of disabling test jobs on schedule pipelines
.test-policy:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: on_success

# To Be Continuous based
# software delivery job prototype: run on production and integration branches + release pipelines
.delivery-policy:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # on tag with release pattern
    - if: '$CI_COMMIT_TAG =~ $RELEASE_REF'
    # on production or integration branch(es)
    - if: '$CI_COMMIT_REF_NAME =~ $PROD_REF || $CI_COMMIT_REF_NAME =~ $INTEG_REF'

.semrel-base:
  variables:
    GIT_DEPTH: "0"
    GITLAB_TOKEN: $RELEASE_TOKEN

semantic-release-info:
  stage: build
  variables:
    SEMREL_DRY_RUN: "true"
  script:
    - !reference [semantic-release, script]
    - source "$SEMREL_CONFIG_DIR/semrel.out.env" && rm "$SEMREL_CONFIG_DIR/semrel.out.env"
    - >
      echo "BRANCH_SHA=$(echo "$CI_COMMIT_REF_NAME" | sha256sum | cut -c -8)" >> "$SEMREL_CONFIG_DIR/semrel.out.env"

      if [ -n "$SEMREL_INFO_NEXT_VERSION" ]; then
        echo "SEMREL_INFO_LAST_VERSION=v${SEMREL_INFO_LAST_VERSION#v}" >> "$SEMREL_CONFIG_DIR/semrel.out.env"
        echo "SEMREL_INFO_NEXT_VERSION=v${SEMREL_INFO_NEXT_VERSION#v}" >> "$SEMREL_CONFIG_DIR/semrel.out.env"
        echo "SEMREL_INFO_NEXT_VERSION_TYPE=${SEMREL_INFO_NEXT_VERSION_TYPE}" >> "$SEMREL_CONFIG_DIR/semrel.out.env"
      else
        DESCRIBE=$(git describe --tags || echo "v1.0.0")
        echo "SEMREL_INFO_NEXT_VERSION=v${DESCRIBE#v}" >> "$SEMREL_CONFIG_DIR/semrel.out.env"
        echo "SEMREL_INFO_NEXT_VERSION_TYPE=build" >> "$SEMREL_CONFIG_DIR/semrel.out.env"
      fi
    - cat "$SEMREL_CONFIG_DIR/semrel.out.env"

semantic-release:
  interruptible: false
  dependencies:
    - go-build
